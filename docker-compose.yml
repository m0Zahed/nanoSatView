services:
  auth-service:
    build:
      context: ./nanoSatAPI/UserManagement
      dockerfile: Dockerfile
    env_file:
      - ./nanoSatAPI/UserManagement/.env
    ports:
      - "5000:5000"
    environment:
      PORT: 5000
      APP_VERSION: dev
      CLIENT_ORIGIN: https://nanosatview.com
      VERIFY_PAGE_URL: https://nanosatview.com/verify-email
      RESET_PAGE_URL: https://nanosatview.com/reset-password
      GOOGLE_REDIRECT_URI: https://nanosatview.com/api/auth/google/callback
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      EMAIL_FROM: ${EMAIL_FROM:-no-reply@local.test}
    depends_on:
      - mailhog

  requirements-api:
    build:
      context: ./nanoSatAPI/ProjectManagement
      dockerfile: Dockerfile
    ports:
      - "5001:5001"
    environment:
      ConnectionStrings__Default: Host=postgres;Port=5432;Database=requirements;Username=postgres;Password=postgres
      ALLOWED_ORIGINS: https://nanosatview.com
      FRONTEND__BASE_URL: https://nanosatview.com
      APP_VERSION: dev
    depends_on:
      - postgres

  client-web:
    build:
      context: ./nanoSatSystems
      dockerfile: Dockerfile
      args:
        VITE_AUTH_BASE_URL: /api
        VITE_REQUIREMENTS_BASE_URL: /api/requirements
    ports:
      - "5173:5173"

  typesense:
    image: typesense/typesense:26.0
    restart: "no"
    ports:
      - "8200:8108"
    volumes:
      - ./typesense_server:/data
    command: "--data-dir /data --api-key=xyz --enable-cors"

  postgres:
    image: postgres:16-alpine
    container_name: projectmanagement-postgres
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: requirements
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data

  mailhog:
    image: mailhog/mailhog:v1.0.1
    ports:
      - "1025:1025"
      - "8025:8025"

  reverse-proxy:
    image: nginx:1.25-alpine
    depends_on:
      - auth-service
      - requirements-api
      - client-web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./assets/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./assets/nginx/certs:/etc/nginx/certs:ro
      - ./assets/nginx/letsencrypt:/etc/letsencrypt:ro
      - ./assets/nginx/webroot:/var/www/certbot:ro
    restart: unless-stopped

volumes:
  postgres-data:
